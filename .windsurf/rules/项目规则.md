---
trigger: always_on
---

---
trigger: always_on
---

# BettaFish 微舆项目工作空间规则

## 适用范围
- **适用对象**：`d:/Python-Learning/bettafish/` 工作区内的全部文件与对话。
- **语言要求**：所有与 Cascade 的交流、代码注释与文档内容需使用中文。

## 核心原则

### 1. 禁止伪造或生成假数据
- 数据缺失时必须如实为空或抛出异常，不得补全示例或占位数据。
- **良好示例**：
  ```python
  if not sentiment_data:
      raise ValueError("未能提取到情感分析数据")
  ```
- **不良示例**：
  ```python
  if not sentiment_data:
      sentiment_data = [{"sentiment": "未知", "score": 0.5}]
  ```

### 2. 回复与内容真实性
- 所有回答必须使用中文并基于事实，不得凭空猜测或捏造结论。
- **良好示例**：根据代码分析错误原因并给出可验证的修改建议。
- **不良示例**：笼统建议"重启服务器"而无事实依据。

### 3. 方案需附出处
- 提供编程方案时需注明参考文档或标准规范，严禁虚构引用。
- **良好示例**：引用官方文档链接并给出对应代码片段。

## 代码规范

### 注释与文档字符串
- 代码注释、文档字符串统一使用中文，解释功能、参数与返回值。
- Python 文件应在开头包含 UTF-8 编码声明与文件说明块。
- 示例：
  ```python
  # -*- coding: utf-8 -*-
  """
  模块说明
  
  详细描述模块功能
  """
  ```

### 导入与命名约定
- 模块导入顺序：标准库 → 第三方库 → 项目模块。
- 变量与函数使用下划线命名法；类使用驼峰命名法。
- 示例：
  ```python
  # 标准库
  import os
  import json
  from pathlib import Path
  
  # 第三方库
  import requests
  from openai import OpenAI
  from loguru import logger
  
  # 项目模块
  from config import settings
  from utils.retry_helper import retry_on_failure
  ```

### 类型提示
- 添加必要的类型提示以提升可读性与性能。
- 函数签名添加类型提示，优先使用 Pydantic 模型。
- 示例：
  ```python
  from typing import Dict, Any, List, Optional
  
  def analyze_sentiment(text: str) -> Dict[str, Any]:
      """分析文本情感"""
      pass
  ```

### 文件头部风格一致性
- 保持源文件头部注释格式一致，包含文件信息与描述。

## 配置管理（重要）

### 配置访问规则
- **必须**通过 `config.py` 中的 `settings` 对象访问配置。
- **严禁**硬编码任何配置参数到代码中。
- **严禁**通过命令行参数传入配置。
- 配置缺失时须抛出异常，不得在代码中设置默认值。
- 所有配置从 `.env` 文件读取（通过 Pydantic Settings 自动加载）。

### 配置文件位置
- **主配置文件**：`config.py`（使用 Pydantic Settings）
- **环境变量文件**：`.env`（实际配置值）
- **示例文件**：`.env.example`（配置模板）

### 绝对禁止hardcode的参数
包括但不限于：
- **AI参数**：`temperature`、`max_tokens`、`model`、`api_key`、`base_url`
- **网络参数**：`timeout`、`retry_count`、`max_retries`
- **数据库参数**：`host`、`port`、`user`、`password`、`database`
- **文件路径**：输入/输出目录、模板路径、日志路径、报告路径
- **业务参数**：批次大小、阈值、限制数量、搜索限制
- **端口号**：Flask端口、Streamlit应用端口

### 良好示例
```python
# ✅ 正确：从配置读取
from config import settings

class InsightAgent:
    def __init__(self):
        self.api_key = settings.INSIGHT_ENGINE_API_KEY
        self.base_url = settings.INSIGHT_ENGINE_BASE_URL
        self.model_name = settings.INSIGHT_ENGINE_MODEL_NAME
        self.max_results = settings.DEFAULT_SEARCH_TOPIC_GLOBALLY_LIMIT_PER_TABLE
```

### 不良示例
```python
# ❌ 错误：hardcode参数
class InsightAgent:
    def __init__(self):
        self.api_key = "sk-xxx"  # 禁止！
        self.base_url = "https://api.moonshot.cn/v1"  # 禁止！
        self.model_name = "kimi-k2-0711-preview"  # 禁止！
        self.max_results = 100  # 禁止！
```

### 违反后果
- 导致配置管理混乱
- 无法统一调整参数
- 违反项目架构原则
- 代码审查不通过
- 安全风险（API密钥泄露）

## 日志与异常处理

### 日志规范
- 使用 `loguru` 库的 `logger` 进行日志记录。
- 捕获异常后记录详细错误信息，**禁止使用 `print` 输出**。
- 所有日志写入项目根目录下的 `logs/`。
- 示例：
  ```python
  from loguru import logger
  
  try:
      result = process_sentiment_data()
      logger.info(f"情感分析完成，处理了 {len(result)} 条数据")
  except Exception as e:
      logger.error(f"处理数据失败: {e}", exc_info=True)
      raise
  ```

### 异常处理
- 在函数开头处理异常与边界情况。
- 不要吞掉异常，必须记录或重新抛出。
- 提供有意义的错误信息。

## 工具与依赖

### 复用工具类
- 优先使用 `utils/` 目录下现有工具类，不重复造轮子。
- 现有工具类包括：
  - `utils.retry_helper`：重试机制工具
  - `utils.forum_reader`：论坛日志读取工具
  - `utils.github_issues`：GitHub Issues 集成工具

### 依赖管理
- 使用 `requirements.txt` 管理依赖。
- **禁止**在全局环境安装依赖。
- 新增依赖时必须更新 `requirements.txt`。

### 虚拟环境隔离
- 每个项目使用独立虚拟环境。
- 禁止直接在系统环境安装依赖。

## 框架规范

### Flask 规范
- 主应用文件：`app.py`
- 使用 Flask-SocketIO 进行实时通信。
- 路由定义需声明返回类型。
- API端点统一使用 `/api/` 前缀。
- 示例：
  ```python
  @app.route('/api/engine-config', methods=['GET'])
  def get_engine_config():
      """获取Engine配置"""
      try:
          # 实现逻辑
          return jsonify({'success': True, 'config': config})
      except Exception as exc:
          logger.exception("读取Engine配置失败")
          return jsonify({'success': False, 'message': f'读取配置失败: {exc}'}), 500
  ```

### Streamlit 规范
- 单引擎应用位于 `SingleEngineApp/` 目录。
- 应用命名格式：`{engine_name}_streamlit_app.py`
- 端口分配：
  - Insight Engine: 8501
  - Media Engine: 8502
  - Query Engine: 8503

### Python 3.12 规范
- 采用 Python 3.12 推荐特性与最佳实践。
- 使用类型提示增强代码可读性。

## 开发规范

### 聚焦功能修复
- Bug 修复与重构需聚焦指定功能，避免大范围无关修改。
- 一次只解决一个问题。

### 文档要求
- 各一级子目录需维护 `README.md`，说明子目录内文件用途。
- 重要功能需添加使用说明。

### 控制台输出字符集
- 控制台输出仅使用 ASCII 字符，避免 GBK 编码问题。
- 日志文件使用 UTF-8 编码。

## 项目特定规范

### 项目架构
BettaFish 采用多智能体架构，包含以下核心组件：

#### 1. 核心引擎（Engines）
- **InsightEngine**：私有数据库挖掘，分析本地社交媒体数据
  - 位置：`InsightEngine/`
  - 主文件：`agent.py`
  - 配置：`INSIGHT_ENGINE_*` 系列环境变量

- **MediaEngine**：多模态内容分析，全网搜索与多媒体内容理解
  - 位置：`MediaEngine/`
  - 主文件：`agent.py`
  - 配置：`MEDIA_ENGINE_*` 系列环境变量

- **QueryEngine**：精准信息搜索，全球新闻源检索与信息汇总
  - 位置：`QueryEngine/`
  - 主文件：`agent.py`
  - 配置：`QUERY_ENGINE_*` 系列环境变量

- **ReportEngine**：最终报告生成
  - 位置：`ReportEngine/`
  - 主文件：`agent.py`、`flask_interface.py`
  - 配置：`REPORT_ENGINE_*` 系列环境变量

- **ForumEngine**：多智能体协同交流（Host Engine）
  - 位置：`ForumEngine/`
  - 主文件：`llm_host.py`、`monitor.py`
  - 配置：`FORUM_HOST_*` 系列环境变量

#### 2. 数据爬虫
- **MindSpider**：AI驱动的爬虫集群
  - 位置：`MindSpider/`
  - 支持平台：微博、小红书、抖音、快手、知乎、贴吧、B站

#### 3. 情感分析
- **SentimentAnalysisModel**：多语言情感分析模型
  - 位置：`SentimentAnalysisModel/`
  - 支持22种语言的情感分析

#### 4. 前端界面
- **主界面**：`templates/index.html`
- **静态资源**：`static/`
- **报告输出**：`final_reports/`

### Engine配置管理
- Engine启用状态保存在 `.env` 文件中的 `ENABLED_ENGINES` 变量
- 格式：JSON字符串，如 `{"insight": true, "media": true, "query": false}`
- 通过前端 "Engine配置" 按钮进行配置
- API端点：`/api/engine-config`（GET/POST）

### 数据库连接
- 使用 SQLAlchemy 连接数据库
- 支持 MySQL 和 PostgreSQL
- 配置参数：`DB_DIALECT`、`DB_HOST`、`DB_PORT`、`DB_USER`、`DB_PASSWORD`、`DB_NAME`

### API集成
- **Tavily API**：新闻搜索（QueryEngine）
  - 配置：`TAVILY_API_KEY`
  
- **Bocha AI Search API**：全网搜索（MediaEngine）
  - 配置：`BOCHA_WEB_SEARCH_API_KEY`、`BOCHA_BASE_URL`

### 搜索限制配置
所有搜索相关的限制参数都在 `config.py` 中定义：
- `DEFAULT_SEARCH_HOT_CONTENT_LIMIT`：热榜内容默认最大数
- `DEFAULT_SEARCH_TOPIC_GLOBALLY_LIMIT_PER_TABLE`：按表全局话题最大数
- `DEFAULT_SEARCH_TOPIC_BY_DATE_LIMIT_PER_TABLE`：按日期话题最大数
- `DEFAULT_GET_COMMENTS_FOR_TOPIC_LIMIT`：单话题评论最大数
- `DEFAULT_SEARCH_TOPIC_ON_PLATFORM_LIMIT`：平台搜索话题最大数
- `MAX_REFLECTIONS`：最大反思次数
- `SEARCH_TIMEOUT`：单次搜索请求超时

### 报告生成
- 报告模板支持自定义（通过前端上传 .md 或 .txt 文件）
- 报告输出目录：`final_reports/`
- 报告格式：HTML
- 报告生成由 ReportEngine 负责

### 日志管理
- 日志目录：`logs/`
- 各引擎独立日志文件
- 使用 loguru 进行日志记录
- 日志级别：INFO、WARNING、ERROR

### 重试机制
- 使用 `utils.retry_helper` 进行重试
- 支持指数退避
- 可配置重试次数和延迟

### 前端开发规范
- 主模板：`templates/index.html`
- CSS样式：内联在 HTML 中
- JavaScript：使用原生 JS + Socket.IO
- 配置弹窗样式需与现有 "LLM配置" 保持一致
- 使用黑白简约设计风格

### 避免重复开发
在开发新功能前，必须检查以下位置是否已有类似实现：

1. **配置相关**：
   - 检查 `config.py` 是否已定义相关配置项
   - 检查 `.env.example` 是否有配置模板
   - 检查 `app.py` 是否已有相关 API 端点

2. **工具类**：
   - 检查 `utils/` 目录下是否有可复用的工具
   - 检查各 Engine 目录下是否有共享的辅助函数

3. **前端组件**：
   - 检查 `templates/index.html` 是否已有类似的模态框或组件
   - 复用现有的 CSS 样式类

4. **API端点**：
   - 检查 `app.py` 中是否已有类似的路由
   - 复用现有的错误处理模式

5. **数据模型**：
   - 检查各 Engine 的数据结构定义
   - 避免重复定义相同的数据模型

## 测试规范

### 测试文件位置
- 测试文件位于 `tests/` 目录
- 测试文件命名：`test_*.py`
- 运行测试：`python tests/run_tests.py`

### 测试覆盖
- 核心功能必须有单元测试
- API端点需要集成测试
- 关键业务逻辑需要测试覆盖

## Git 规范

### 提交信息
- 使用中文描述提交内容
- 格式：`[类型] 简短描述`
- 类型：新增、修复、优化、重构、文档

### 分支管理
- 主分支：`main`
- 功能分支：`feature/功能名称`
- 修复分支：`fix/问题描述`

## 扩展规则
- 若需扩展规则，请在 `.windsurf/rules/` 目录新增 Markdown 文件并注明适用范围。
- 新规则需与现有规则保持一致。
